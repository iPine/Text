<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>模糊聚类结果可视化</title>
	<link rel="stylesheet" href="./plug/bootstrap-3.3.5-dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/base.css">
	<link rel="stylesheet" href="./css/index.css">
	<script type="text/javascript" src="./plug/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="./plug/bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
	
	<script type="text/javascript" src="lib/d3.min.js"></script>
    <script type="text/javascript" src="lib/crossfilter.min.js"></script>
    <script type="text/javascript" src="lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="lib/d3.tip.v0.6.3.js"></script>
    <script src="lib/numeric-1.2.6.min.js"></script>
    <script src="lib/mds.js"></script>
    <script src="lib/d3.svg.multibrush.js"></script>
    <script src="lib/divgrid.js"></script>
    

	<link rel="stylesheet" type="text/css" href="css/style_radviz.css">
    <link rel="stylesheet" type="text/css" href="css/style_tips.css">
    <link rel="stylesheet" type="text/css" href="css/d3.parcoords_top.css">
    <link rel="stylesheet" type="text/css" href="css/style_originTag.css">
    <link rel="stylesheet" type="text/css" href="css/style_clusterTag.css">

    <!-- SlickGrid -->
<link rel="stylesheet" href="lib/slickgrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/jquery-ui-1.8.16.custom.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/examples.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/slick.pager.css" type="text/css"/>
<script src="lib/slickgrid/jquery-1.7.min.js"></script>
<script src="lib/slickgrid/jquery.event.drag-2.0.min.js"></script>
<script src="lib/slickgrid/slick.core.js"></script>
<script src="lib/slickgrid/slick.grid.js"></script>
<script src="lib/slickgrid/slick.pager.js"></script>
<script src="lib/slickgrid/slick.dataview.js"></script>
<!-- End SlickGrid -->
    
</head>
<body>

<script src="js/radviz.js"></script>
<script src="js/d3.parcoords.js"></script>
<script src="js/arc.js"></script>
<script src="js/mds-scatter.js"></script>

	<div id="leftContainer">
		<div class="leftTop box">
			<div class="navStripe">
				<div class="col-sm-4">
          <span class="glyphicon glyphicon-stats"></span>Fuzzy Clustering Data    
        </div>
				
        <div class="dropdown" style="position:relative;">
            <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" style="padding: 0;height: 20px;width: 80px;font-size: 10px;background-color: #D9E3E8;color:#333; border-color: #D9E3E8;padding: 0;vertical-align: top;">Selection <span class="caret"></span></a>
            <ul class="dropdown-menu" style="font-size: 10px;padding: 0;">
              <li>
                <a class="trigger right-caret" id="wine">Wine</a>
                <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                  <li><a href="#" id="4">4</a></li>
                  <li><a href="#" id="5">5</a></li>
                  <li><a href="#" id="6">6</a></li>
                </ul>
              </li>
              <li>
                <a class="trigger right-caret" id="iris">Iris</a>
                <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                  <li><a href="#" id="2">2</a></li>
                  <li><a href="#" id="3">3</a></li>
                  <li><a href="#" id="4">4</a></li>
                </ul>
              </li>
              <li><a class="trigger right-caret">Ecoli</a>
                <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                  <li><a href="#" id="4">4</a></li>
                  <li><a href="#" id="5">5</a></li>
                  <li><a href="#" id="6">6</a></li>
                </ul>
              </li>
            </ul>
          </div>
      </div>

			<div id="radviz"></div>
		
		</div>      
	</div>

	<div id="rightContainer">
		<div class="rightTop box">
            <div class="navStripe">

            <div class="col-sm-3">
              <span class="glyphicon glyphicon-menu-hamburger"></span>Original Data
            </div>
            
              <div class="col-sm-1">
                    <div class="panel-body" style="margin: 0; padding: 0;">
                       <div class="btn-group" style="padding: 0;">
                         <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" style="height: 20px;width: 80px;    background-color: #D9E3E8; padding: 0;">
                           <span data-bind="label" style="margin-left: -1px;font-size: 10px;vertical-align:top;">Selection</span>&nbsp;<span class="caret"></span>
                         </button>
                         <ul class="dropdown-menu" role="menu" style="font-size: 8px;min-width: 80px;padding: 0px 0;">
                           <li style="padding: 0;"><a href="#" class="dataset" id="wine">Wine</a></li>
                           <li style="padding: 0;"><a href="#" class="dataset" id="iris">Iris</a></li>
                           <li style="padding: 0;"><a href="#" class="dataset" id="ecoli">Ecoli</a></li>
                           <!-- <li><a href="#">This is a longer item that will not fit properly</a></li> -->
                         </ul>
                       </div>
                     </div>
              </div>
            </div>
            
            <div id="col">
                <div id="pager"></div>
                <div id="grid"></div>
            </div>
            <div id="MDS"></div>        
        </div>

        <div class="rightBottom box">
            <div class="navStripe">
               <div class="col-sm-4">
              <span class="glyphicon glyphicon-th"></span>Parallel Coordinates  
              </div>
            </div>

            <div id="example" class="parcoords"></div>
            <div id="inforPanel"></div>

        </div>      
    </div>
	<script>

  //originTag切换
   $( document.body ).on( 'click', '.dropdown-menu li', function( event ) {

      var $target = $( event.currentTarget );

      $target.closest( '.btn-group' )
         .find( '[data-bind="label"]' ).text( $target.text() )
            .end()
         .children( '.dropdown-toggle' ).dropdown( 'toggle' );

      return false;

   });

   $('.dataset').click(function(){

    var dataName = $(this).attr('id'); 

    updateData(dataName);
   })

   function updateData(name){
    d3.select('#pager').selectAll('*').remove();
    d3.select('#grid').selectAll('*').remove();
    d3.select('#MDS').selectAll('*').remove();
    d3.select("#example").selectAll('*').remove();
    var fillName = "data/raw/" + name + "-raw.csv";       
             d3.csv(fillName,function(data){
                    var dim;
                    parcoordsRender(data);
                    if(name == "ecoli") dim = 7;
                    if(name == "iris") dim = 4;
                    if(name == "wine") dim = 13;
                    // if(name == "Synthetic") dim = 12;
                    mdsScatter(data,"#MDS",dim);
                }); 
   }

   //clusterTag切换
   $(function(){
      $(".dropdown-menu > li > a.trigger").on("click",function(e){

        var current=$(this).next();
        var grandparent=$(this).parent().parent();
        if($(this).hasClass('left-caret')||$(this).hasClass('right-caret'))
          $(this).toggleClass('right-caret left-caret');
        grandparent.find('.left-caret').not(this).toggleClass('right-caret left-caret');
        grandparent.find(".sub-menu:visible").not(current).hide();
        current.toggle();
        e.stopPropagation();
      });
      $(".dropdown-menu > li > a:not(.trigger)").on("click",function(){
        var root=$(this).closest('.dropdown');
        root.find('.left-caret').toggleClass('right-caret left-caret');
        root.find('.sub-menu:visible').hide();
      });
  });




		var svg = d3.select("#radviz").append("svg")
                .attr("width",600)
                .attr("height",600);

         var cNum = 4;
	var radvizConfig = {

	 	el: document.querySelector('#radviz'), // container node or selector
        size: 600, 
        margin: 150, // margin around the circular panel, to leave some room for the labels
        dimensions: dimensions(cNum), // data keys to use as dimensions
        colorAccessor: function(d){return d.classId;}, // dimension to use for coloring
        opacityAccessor: function(d){return d.classValue;},
        colorScale: d3.scale.ordinal().range(['orange', '#de3669', '#52b5f3', 'purple', '#6ab82c',
                '#802A2A', '#58c3e0', ' #385E0F', '#e3701e', 'teal',
                '#04389A', 'black']),//d3.scale.category10(), // color palette
        drawLinks: false, 
        zoomFactor: 1, 
        dotRadius: 4, 
        useTooltip: false,
        useRepulsion: false,
	 }

	var radviz = radvizComponent()
    .config(radvizConfig)
    .on('dotEnter', function(d) {
    	 // console.log(d);
            renderList(d);
        
        // pcz.highlight([d]);
        parcoords.highlight([d]);
              
    })
    .on('dotLeave', function(d) {
                // console.log('dotLeave', d);
        
        // pcz.unhighlight([d]);
        parcoords.unhighlight([d]);
                 
    })
    .on('panelEnter', function() {
        // mouse entered the circular panel
    })
    .on('panelLeave', function() {
        // mouse left the circular panel
    });

/*隶属度条型图展示*/
    var renderList = function(datum) {

    	var height_scale = d3.scale.linear()
    						.domain([0,1])
    						.range([0,90]);

        d3.select('#state').selectAll("div").remove();

            var text = d3.select('#state')
                .append('div')
                .attr('class',"label");

            text.text(function(d){
            		return "dot " + (datum.index + 1) + " belongs to " + "cluster " + datum.classId;
            	})
                .style('font-family', 'sans-serif')
                .style('font-size','11px')
                .style('fill','gray');
          
            var list = d3.select('#list')
                .selectAll('div.item')
                .data(dimensions(cNum));

            list.enter()
            	.append('div')
            	.classed('item', true);

            list.transition()
            	.style({
                    height: function(d) {
                        return height_scale(datum[d]) + 'px';
                    },
                })
                .text(function(d) {
                    return d + ': ' + datum[d];
                })
                .style('font-size','8px')
                .style('font-family', 'sans-serif');
            list.exit().remove();
            
        };


    function dimensions(cNum){
	 	 var dimensions = [];
		 for(var i=0; i<cNum; i++){
		 	dimensions.push("C" + (i+1));
		 }
		 return dimensions;
	};
   
    function maxLabel(data){
        for(var i=0; i<data.length; i++){

            var keys = d3.keys(data[i]);

            var max = 0, maxlabel = '';

            keys.forEach(function(key){

                var num = +data[i][key] + 0.0;

                maxlabel = max > num ? maxlabel : key;

                 max = max > num ? max : num;

            })

            data[i].classId = maxlabel;
            data[i].classValue = max;
        }
    }


    /*平行坐标及table的绘制*/
    var parcoords;
     function parcoordsRender(data){

        var blue_to_brown = d3.scale.linear()
        .domain([0, 1])
        .range(["#4FC5C7", "#b490ca"])
        .interpolate(d3.interpolateLab);

        var colorline = function(d){return blue_to_brown(d['C1']||d['col2']);};
         // var colorline = function(d){return blue_to_brown(d3.keys(data[0]));};

         data.forEach(function(d,i) { d.id = d.id || i; });

          parcoords = d3.parcoords()("#example")
                          // .alpha(0.4)
                          .mode("queue") // progressive rendering
                          .height(d3.max([160, 150]))
                          .margin({
                            top: 56,
                            left: 0,
                            right: 0,
                            bottom: 5
                          });

          parcoords
            .data(data)
            .color(colorline)
            .alpha(0.35)
            .render()
            .reorderable()
            .brushMode("2D-strums");

          // setting up grid
          var column_keys = d3.keys(data[0]);
          var columns = column_keys.map(function(key,i) {
            return {
              id: key,
              name: key,
              field: key,
              sortable: true
            }
          });

          var options = {
            enableCellNavigation: true,
            enableColumnReorder: false,
            multiColumnSort: false
          };

          var dataView = new Slick.Data.DataView();
          var grid = new Slick.Grid("#grid", dataView, columns, options);
          var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));

          // wire up model events to drive the grid
          dataView.onRowCountChanged.subscribe(function (e, args) {
            grid.updateRowCount();
            grid.render();
          });

          dataView.onRowsChanged.subscribe(function (e, args) {
            grid.invalidateRows(args.rows);
            grid.render();
          });

          // column sorting
          var sortcol = column_keys[0];
          var sortdir = 1;

          function comparer(a, b) {
            var x = a[sortcol], y = b[sortcol];
            return (x == y ? 0 : (x > y ? 1 : -1));
          }
          
          // click header to sort grid column
          grid.onSort.subscribe(function (e, args) {
            sortdir = args.sortAsc ? 1 : -1;
            sortcol = args.sortCol.field;

            if ($.browser.msie && $.browser.version <= 8) {
              dataView.fastSort(sortcol, args.sortAsc);
            } else {
              dataView.sort(comparer, args.sortAsc);
            }
          });

          // highlight row in chart
          grid.onMouseEnter.subscribe(function(e,args) {
            var i = grid.getCellFromEvent(e).row;
            var d = parcoords.brushed() || data;
            parcoords.highlight([d[i]]);
          });
          grid.onMouseLeave.subscribe(function(e,args) {
            parcoords.unhighlight();
          });

          // fill grid with data
          gridUpdate(data);

          // update grid on brush
          parcoords.on("brush", function(d) {
            gridUpdate(d);
          });

          function gridUpdate(data) {
            dataView.beginUpdate();
            dataView.setItems(data);
            dataView.endUpdate();
          };
    }


    d3.csv('data/wine_7.csv', function(err,data) {
        if(err) throw error;

        renderArcs(data);  	  
    	  maxLabel(data);
        radviz.render(data); 
        mdsScatter(data,"#MDS",cNum);                    
          	
   });

    d3.csv("data/wine_7.csv",function(err,data){
        parcoordsRender(data);
    })

	</script>
</body>
</html>