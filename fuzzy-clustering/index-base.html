<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>模糊聚类结果可视化</title>
	<link rel="stylesheet" href="./plug/bootstrap-3.3.5-dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="./css/base.css">
	<link rel="stylesheet" href="./css/index.css">
	<script type="text/javascript" src="./plug/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="./plug/bootstrap-3.3.5-dist/js/bootstrap.min.js"></script>
	
	<script type="text/javascript" src="lib/d3.min.js"></script>
    <script type="text/javascript" src="lib/crossfilter.min.js"></script>
    <script type="text/javascript" src="lib/jquery-3.1.1.min.js"></script>
    <script type="text/javascript" src="lib/d3.tip.v0.6.3.js"></script>
    <script src="lib/numeric-1.2.6.min.js"></script>
    <script src="lib/mds.js"></script>
    <script src="lib/d3.svg.multibrush.js"></script>
    <script src="lib/divgrid.js"></script>
    

	<link rel="stylesheet" type="text/css" href="css/style_radviz.css">
    <link rel="stylesheet" type="text/css" href="css/style_tips.css">
    <link rel="stylesheet" type="text/css" href="css/d3.parcoords_top.css">
    <link rel="stylesheet" type="text/css" href="css/style_originTag.css">
    <link rel="stylesheet" type="text/css" href="css/style_clusterTag.css">

    <!-- SlickGrid -->
<link rel="stylesheet" href="lib/slickgrid/slick.grid.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/jquery-ui-1.8.16.custom.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/examples.css" type="text/css"/>
<link rel="stylesheet" href="lib/slickgrid/slick.pager.css" type="text/css"/>
<script src="lib/slickgrid/jquery-1.7.min.js"></script>
<script src="lib/slickgrid/jquery.event.drag-2.0.min.js"></script>
<script src="lib/slickgrid/slick.core.js"></script>
<script src="lib/slickgrid/slick.grid.js"></script>
<script src="lib/slickgrid/slick.pager.js"></script>
<script src="lib/slickgrid/slick.dataview.js"></script>
<!-- End SlickGrid -->
    
</head>
<body>

<script src="js/radviz.js"></script>
<script src="js/d3.parcoords.js"></script>
<script src="js/arc.js"></script>
<script src="js/mds-scatter.js"></script>

	<div id="leftContainer">
		<div class="leftTop box">
			<div class="navStripe">
				<div class="col-sm-2">
          <span class="glyphicon glyphicon-stats"></span>   
        </div>
				
      </div>

			<div id="radviz"></div>
		</div>      
	</div>

	<div id="rightContainer" class="box">

              <ul id="interactionTab" class="navStripe nav nav-tabs">
                <li class="avtive active">
                  <a href="#fc" data-toggle="tab" id="fc">Fuzzy Clustering Data</a>
                </li>
                <li>
                  <a href="#od" data-toggle="tab" id="od">Original Data</a>
                </li>
                <li>
                  <!-- <a href="#blank" data-toggle="tab">tab-btn</a> -->
                  
                  <div class="dropdown" style="position:relative;">
                    <a href="#" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" style="padding: 0;height: 20px;width: 80px;font-size: 14px;background-color: #F9C397;color:gray; border-color: #D9E3E8;padding: 0;vertical-align: middle;border-color: #F9C397;"><span id="da">Wine</span><span class="caret" style="margin-left: 2px;"></span></a>
                    <ul class="dropdown-menu" style="font-size: 10px;padding: 0;min-width: 80px;">
                      <li>
                        <a class="trigger right-caret" id="wine">Wine</a>
                        <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                          <li><a href="#" id="4" class="number">4</a></li>
                          <li><a href="#" id="5" class="number">5</a></li>
                          <li><a href="#" id="6" class="number">6</a></li>
                        </ul>
                      </li>
                      <li>
                        <a class="trigger right-caret" id="iris">Iris</a>
                        <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                          <li><a href="#" id="2" class="number">2</a></li>
                          <li><a href="#" id="3" class="number">3</a></li>
                          <li><a href="#" id="4" class="number">4</a></li>
                        </ul>
                      </li>
                      <li>
                        <a class="trigger right-caret" id="ecoli">Ecoli</a>
                        <ul class="dropdown-menu sub-menu" style="font-size: 10px;padding: 0;">
                          <li><a href="#" id="4" class="number">4</a></li>
                          <li><a href="#" id="5" class="number">5</a></li>
                          <li><a href="#" id="6" class="number">6</a></li>
                        </ul>
                      </li>
                    </ul>
                  </div>
                </li>
              </ul>

              <div id="tabContent" class="tab-content">
                <div class="tab-pane fade in active" id="fc"> </div>
                <div class="tab-pane fade" id="od"></div>
                
                <div id="col">
                        <div id="pager"></div>
                        <div id="grid"></div>
                </div>
                <div id="MDS"></div>   
                <div id="example" class="parcoords"></div>

            </div>
    </div>
	<script>

//加载后：Fuzzydata与Origindata之间的切换

  // $('#od').click(function(){   
   
  //     d3.select('#pager').selectAll('*').remove();
  //     d3.select('#grid').selectAll('*').remove();
  //     d3.select('#MDS').selectAll('*').remove();
  //     d3.select("#example").selectAll('*').remove();

  //     d3.csv("data/raw/wine-raw.csv",function(data){
  //     parcoordsRender(data);
  //     mdsScatter(data,"#MDS",13);
  //     })  
  //  });
  // $('#fc').click(function(){
  
  //     d3.select('#pager').selectAll('*').remove();
  //     d3.select('#grid').selectAll('*').remove();
  //     d3.select('#MDS').selectAll('*').remove();
  //     d3.select("#example").selectAll('*').remove();
  //     d3.csv("data/wine_7.csv",function(data){
  //     parcoordsRender(data);
  //     mdsScatter(data,"#MDS",7);
  //     })
  //  });


 

//选择数据集的button设置
   $(function(){
      $(".dropdown-menu > li > a.trigger").on("click",function(e){

        // var $target = $(e.currentTarget);

        $('#da').text($(this).text());

        var current=$(this).next();
        var grandparent=$(this).parent().parent();


        if($(this).hasClass('left-caret')||$(this).hasClass('right-caret'))
          $(this).toggleClass('right-caret left-caret');
        grandparent.find('.left-caret').not(this).toggleClass('right-caret left-caret');
        grandparent.find(".sub-menu:visible").not(current).hide();
        current.toggle();
        e.stopPropagation();
      });
      $(".dropdown-menu > li > a:not(.trigger)").on("click",function(){
        var root=$(this).closest('.dropdown');
        root.find('.left-caret').toggleClass('right-caret left-caret');
        root.find('.sub-menu:visible').hide();
      });
  });


//更新数据集后，OriginData和ClusteringData之间的切换
  var dataName;
  var clusterNum;

  $('.navStripe > li:first-child').select(function(){
    $('.navStripe > li:first-child').addClass('active');
    $('.navStripe > li:eq(1)').removeClass('active');
  });

   $(".number").click(function(){
    dataName = $(this).parent().parent().siblings('a').attr("id");
    clusterNum = $(this).attr("id");
    updateCluster(clusterNum,dataName);  

    $('.navStripe > li:first-child').trigger('select');
       
  })


  $('#od').click(function(){
    // updateData(dataName);
    if($('#da').text() == "Wine"){
       updateData("wine");
    }
    else{
      updateData(dataName);
    }
  }); 


   $('#fc').click(function(){
    // updateCluster(clusterNum,dataName);
    if(clusterNum) {

      cNum = clusterNum;
      d3.select('#pager').selectAll('*').remove();
      d3.select('#grid').selectAll('*').remove();
      d3.select('#MDS').selectAll('*').remove();
      d3.select("#example").selectAll('*').remove();
      var fillName = "data/" + dataName + "_" + cNum + ".csv";

             d3.csv(fillName,function(data){
                    parcoordsRender(data);
                    mdsScatter(data,"#MDS",cNum);
                }); 
      
      }
    else{

      d3.select('#pager').selectAll('*').remove();
        d3.select('#grid').selectAll('*').remove();
        d3.select('#MDS').selectAll('*').remove();
        d3.select("#example").selectAll('*').remove();
        d3.csv("data/wine_6.csv",function(data){
          parcoordsRender(data);
          mdsScatter(data,"#MDS",6);
        });
       }
 });
   
  


     function updateData(name){
      d3.select('#pager').selectAll('*').remove();
      d3.select('#grid').selectAll('*').remove();
      d3.select('#MDS').selectAll('*').remove();
      d3.select("#example").selectAll('*').remove();

      var fillName = "data/raw/" + name + "-raw.csv";       
               d3.csv(fillName,function(data){
                      var dim;
                      parcoordsRender(data);
                      if(name == "ecoli") dim = 7;
                      if(name == "iris") dim = 4;
                      if(name == "wine") dim = 13;
                      // if(name == "Synthetic") dim = 12;
                      mdsScatter(data,"#MDS",dim);
                  }); 
     }


    function updateCluster(k,name){
      d3.select('#pager').selectAll('*').remove();
      d3.select('#grid').selectAll('*').remove();
      d3.select('#MDS').selectAll('*').remove();
      d3.select("#example").selectAll('*').remove();

      d3.select("svg").selectAll(".arcs").remove();
      d3.select("svg").selectAll(".hists").remove();
      d3.select("svg").selectAll(".panel").remove();
      d3.select("svg").selectAll(".dot").remove();

      cNum = k;
      var fillName = "data/" + name + "_" + k + ".csv";

             d3.csv(fillName,function(data){
                    parcoordsRender(data);
                }); 
             d3.csv(fillName,function(data){

                renderArcs(data);
                maxLabel(data);

                radvizConfig.dimensions = dimensions(cNum);
                var radviz = radvizComponent()
                .config(radvizConfig)
                .on('dotEnter', function(d) {
                    // renderList(d);
           
                  parcoords.highlight([d]);
                    
                })
                .on('dotLeave',function(d){
                    parcoords.unhighlight([d]);
                });

                radviz.render(data);
                mdsScatter(data,"#MDS",cNum); 

                }); 
    }




		var svg = d3.select("#radviz").append("svg")
                .attr("width",600)
                .attr("height",600);

         var cNum = 6;
	 var radvizConfig = {

	 	el: document.querySelector('#radviz'), // container node or selector
        size: 600, 
        margin: 150, // margin around the circular panel, to leave some room for the labels
        dimensions: dimensions(cNum), // data keys to use as dimensions
        colorAccessor: function(d){return d.classId;}, // dimension to use for coloring
        opacityAccessor: function(d){return d.classValue;},
        colorScale: d3.scale.ordinal().range(['orange', '#de3669', '#52b5f3', 'purple', '#6ab82c',
                '#802A2A', '#58c3e0', ' #385E0F', '#e3701e', 'teal',
                '#04389A', 'black']),//d3.scale.category10(), // color palette
        drawLinks: false, 
        zoomFactor: 1, 
        dotRadius: 4, 
        useTooltip: false,
        useRepulsion: false,
	 }

	var radviz = radvizComponent()
    .config(radvizConfig)
    .on('dotEnter', function(d) {
    	 // console.log(d);
            // renderList(d);
        
       
        parcoords.highlight([d]);
              
    })
    .on('dotLeave', function(d) {
                // console.log('dotLeave', d);
        
        parcoords.unhighlight([d]);
                 
    })
    .on('panelEnter', function() {
        // mouse entered the circular panel
    })
    .on('panelLeave', function() {
        // mouse left the circular panel
    });

/*隶属度条型图展示*/
    // var renderList = function(datum) {

    //   var width_scale = d3.scale.linear()
    //             .domain([0,1])
    //             .range([0,100]);

    //     d3.select('#state').selectAll("div").remove();

    //         var text = d3.select('#state')
    //             .append('div')
    //             .attr('class',"label");

    //         text.text(function(d){
    //             return "dot " + (datum.index + 1) + " belongs to " + "cluster " + datum.classId;
    //           })
    //             .style('font-family', 'sans-serif')
    //             .style('font-size','11px')
    //             .style('fill','gray');
          
    //         var list = d3.select('#list')
    //             .selectAll('div.item')
    //             .data(dimensions(cNum));

    //         list.enter()
    //           .append('div')
    //           .classed('item', true);

    //         list.transition()
    //           .style({
    //                 width: function(d) {
    //                     return width_scale(datum[d]) + 'px';
    //                 },
    //                 // height: function(d,i){
    //                 //     return 200 / cNum;
    //                 // }
    //             })
    //             .text(function(d) {
    //                 return d + ': ' + datum[d];
    //             });
    //         list.exit().remove();
            
    //     };


    function dimensions(cNum){
	 	 var dimensions = [];
		 for(var i=0; i<cNum; i++){
		 	dimensions.push("C" + (i+1));
		 }
		 return dimensions;
	};
   
    function maxLabel(data){
        for(var i=0; i<data.length; i++){

            var keys = d3.keys(data[i]);

            var max = 0, maxlabel = '';

            keys.forEach(function(key){

                var num = +data[i][key] + 0.0;

                maxlabel = max > num ? maxlabel : key;

                 max = max > num ? max : num;

            })

            data[i].classId = maxlabel;
            data[i].classValue = max;
        }
    }


    /*平行坐标及table的绘制*/
    var parcoords;
     function parcoordsRender(data){

        var blue_to_brown = d3.scale.linear()
        .domain([0, 1])
        .range(["#4FC5C7", "#b490ca"])
        .interpolate(d3.interpolateLab);

        var colorline = function(d){return blue_to_brown(d['C1']||d['col2']);};
         // var colorline = function(d){return blue_to_brown(d3.keys(data[0]));};

         data.forEach(function(d,i) { d.id = d.id || i; });

          parcoords = d3.parcoords()("#example")
                          // .alpha(0.4)
                          .mode("queue") // progressive rendering
                          .height(d3.max([160, 250]))
                          .margin({
                            top: 56,
                            left: 0,
                            right: 0,
                            bottom: 5
                          });

          parcoords
            .data(data)
            .color(colorline)
            .alpha(0.35)
            .render()
            .reorderable()
            .brushMode("2D-strums");

          // setting up grid
          var column_keys = d3.keys(data[0]);
          var columns = column_keys.map(function(key,i) {
            return {
              id: key,
              name: key,
              field: key,
              sortable: true
            }
          });

          var options = {
            enableCellNavigation: true,
            enableColumnReorder: false,
            multiColumnSort: false
          };

          var dataView = new Slick.Data.DataView();
          var grid = new Slick.Grid("#grid", dataView, columns, options);
          var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));

          // wire up model events to drive the grid
          dataView.onRowCountChanged.subscribe(function (e, args) {
            grid.updateRowCount();
            grid.render();
          });

          dataView.onRowsChanged.subscribe(function (e, args) {
            grid.invalidateRows(args.rows);
            grid.render();
          });

          // column sorting
          var sortcol = column_keys[0];
          var sortdir = 1;

          function comparer(a, b) {
            var x = a[sortcol], y = b[sortcol];
            return (x == y ? 0 : (x > y ? 1 : -1));
          }
          
          // click header to sort grid column
          grid.onSort.subscribe(function (e, args) {
            sortdir = args.sortAsc ? 1 : -1;
            sortcol = args.sortCol.field;

            if ($.browser.msie && $.browser.version <= 8) {
              dataView.fastSort(sortcol, args.sortAsc);
            } else {
              dataView.sort(comparer, args.sortAsc);
            }
          });

          // highlight row in chart
          grid.onMouseEnter.subscribe(function(e,args) {
            var i = grid.getCellFromEvent(e).row;
            var d = parcoords.brushed() || data;
            parcoords.highlight([d[i]]);
          });
          grid.onMouseLeave.subscribe(function(e,args) {
            parcoords.unhighlight();
          });

          // fill grid with data
          gridUpdate(data);

          // update grid on brush
          parcoords.on("brush", function(d) {
            gridUpdate(d);
          });

          function gridUpdate(data) {
            dataView.beginUpdate();
            dataView.setItems(data);
            dataView.endUpdate();
          };
    }


    d3.csv('data/wine_6.csv', function(err,data) {
        if(err) throw error;
        renderArcs(data);  	  
    	  maxLabel(data);
        radviz.render(data); 
                            
          	
   });

    d3.csv("data/wine_6.csv",function(err,data){
        mdsScatter(data,"#MDS",cNum);
        parcoordsRender(data);
    })

	</script>
</body>
</html>